#include <stdio.h>
#include <stdlib.h>
#include <math.h>
#include <assert.h>

#ifdef FLOAT_ELEM_TEST
#include "mdb_matrix_s.h"
#elif defined DOUBLE_ELEM_TEST
#include "mdb_matrix_d.h"
#else
#error 0
#endif


static void r_filter_new_init(r_filter_new *v);
static elem *r_filter_new_init_r(r_filter_new *v, elem *h, int depth,
				 int *count);

static void r_filter_new_init_n(r_filter_new *v, int *n);
static elem *r_filter_new_init_n_r(r_filter_new *v, elem *h, int *n, int depth,
				   int *count);

static void rs12_filter_new_init_n(rs12_filter_new *v, int *n);
static elem *rs12_filter_new_init_n_r(rs12_filter_new *v, elem *h, int *n,
				      int depth, int *count);


static void r_filter_new_init(r_filter_new *v) {
  int count;

  assert(v);

  count = 1;
  r_filter_new_init_r(v, v->h, 0, &count);
}


static elem *r_filter_new_init_r(r_filter_new *v, elem *h, int depth,
				 int *count) {
  int i;

  assert(depth >= 0);

  if (depth == v->rank - 1) {
    for (i = 0; i < v->n_log[v->rank-1]; i++) {
      h[i] = cos(*count);
      (*count)++;
    }
    h += 2*((int) floor(v->n_log[v->rank - 1]/2) + 1);
  }
  else {
    for (i = 0; i < v->n_log[depth]; i++) {
      h = r_filter_new_init_r(v, h, depth+1, count);
    }
  }

  return h;
}


static void r_filter_new_init_n(r_filter_new *v, int *n) {
  int count;

  assert(v);

  count = 1;
  r_filter_new_init_n_r(v, v->h, n, 0, &count);
}


static elem *r_filter_new_init_n_r(r_filter_new *v, elem *h, int *n, int depth,
				   int *count) {
  int i;

  assert(depth >= 0);

  if (depth == v->rank - 1) {
    for (i = 0; i < n[v->rank-1]; i++) {
      h[i] = cos(*count);
      (*count)++;
    }
    h += 2*((int) floor(v->n_log[v->rank - 1]/2) + 1);
  }
  else {
    for (i = 0; i < n[depth]; i++) {
      h = r_filter_new_init_n_r(v, h, n, depth+1, count);
    }
  }

  return h;
}


static void rs12_filter_new_init_n(rs12_filter_new *v, int *n) {
  int count;

  assert(v);

  count = 1;
  rs12_filter_new_init_n_r(v, v->h, n, 0, &count);
}


static elem *rs12_filter_new_init_n_r(rs12_filter_new *v, elem *h, int *n,
				      int depth, int *count) {
  int i;

  assert(depth >= 0);

  if (depth == v->rank - 1) {
    for (i = 0; i < n[v->rank-1]; i++) {
      h[i] = cos(*count);
      (*count)++;
    }
    h += v->n_phy[v->rank - 1];
  }
  else {
    for (i = 0; i < n[depth]; i++) {
      h = rs12_filter_new_init_n_r(v, h, n, depth+1, count);
    }
  }

  return h;
}



int main(int argc, char **argv) {
  c_filter_new *A;
  r_filter_new *B;
  r_filter_new *B2;
  rs2_filter_new *C;
  rs2_filter_new *D;
  rs12_filter_new *E;

  r_filter_new *X;
  rs12_filter_new *H;

  elem *e_ptr;
  int *m;
  int *m_zp;
  int *n, *n2, *n_idx;
  int *n_phy;
  int *n_phy_zp;
  int rank;
  int n_log, l;
  rs12_filter_new_kind *kind;

  int i;


  /****************************************************************************/
  /* c_filter_new */

  rank = 3;
  n = malloc(sizeof(int) * rank);
  assert(n);

  n[0] = 4;
  n[1] = 2;
  n[2] = 3;

  A = c_filter_new_create(rank, n);
  c_filter_new_set_imag0(A);

  for (i = 0; i < A->N; i++) {
#ifdef OSX
    A->h[i][0] = cos(i+1);
#else
    A->h[i] = cos(i+1);
#endif
  }


  puts("Test complex filter:");
  puts("--------------------");

  printf("\n");
  printf("A:\n");
  c_filter_new_printf(A);

  /* Result:

     A:
     (0, :, :)
     (+0.540302 +0.000000) (-0.416147 +0.000000) (-0.989992 +0.000000)
     (-0.653644 +0.000000) (+0.283662 +0.000000) (+0.960170 +0.000000)

     (1, :, :)
     (+0.753902 +0.000000) (-0.145500 +0.000000) (-0.911130 +0.000000)
     (-0.839072 +0.000000) (+0.004426 +0.000000) (+0.843854 +0.000000)

     (2, :, :)
     (+0.907447 +0.000000) (+0.136737 +0.000000) (-0.759688 +0.000000)
     (-0.957659 +0.000000) (-0.275163 +0.000000) (+0.660317 +0.000000)

     (3, :, :)
     (+0.988705 +0.000000) (+0.408082 +0.000000) (-0.547729 +0.000000)
     (-0.999961 +0.000000) (-0.532833 +0.000000) (+0.424179 +0.000000)

   */


  c_filter_new_dft(A);

  printf("\n");
  printf("dft(A):\n");
  c_filter_new_printf(A);


  /* Result:

     dft(A):
     (0, :, :)
     (-1.116736 +0.000000) (+0.168398 +0.187682) (+0.168398 -0.187682)
     (+1.046713 +0.000000) (+9.437681 -5.715889) (+9.437681 +5.715889)

     (1, :, :)
     (+0.012362 +0.033962) (-0.038003 +0.148974) (-0.163745 +0.038803)
     (-2.313028 +2.269608) (+0.416306 -0.037628) (-0.116759 -1.044905)

     (2, :, :)
     (-0.010581 +0.000000) (-0.095402 +0.057780) (-0.095402 -0.057780)
     (-2.244760 +0.000000) (+0.338499 +0.377261) (+0.338499 -0.377261)

     (3, :, :)
     (+0.012362 -0.033962) (-0.163745 -0.038803) (-0.038003 -0.148974)
     (-2.313028 -2.269608) (-0.116759 +1.044905) (+0.416306 +0.037628)


     Matches Matlab:

     >> A = cos(permute(reshape(1:3*2*4, 3, 2, 4), [2 1 3]));
     >> fftn(A)

     ans(:,:,1) =

       -1.1167             0.1684 + 0.1877i   0.1684 - 0.1877i
        1.0467             9.4377 - 5.7159i   9.4377 + 5.7159i


     ans(:,:,2) =

        0.0124 + 0.0340i  -0.0380 + 0.1490i  -0.1637 + 0.0388i
       -2.3130 + 2.2696i   0.4163 - 0.0376i  -0.1168 - 1.0449i


     ans(:,:,3) =

       -0.0106            -0.0954 + 0.0578i  -0.0954 - 0.0578i
       -2.2448             0.3385 + 0.3773i   0.3385 - 0.3773i


     ans(:,:,4) =

        0.0124 - 0.0340i  -0.1637 - 0.0388i  -0.0380 - 0.1490i
       -2.3130 - 2.2696i  -0.1168 + 1.0449i   0.4163 + 0.0376i


     Matches python:

     n = (4, 2, 3)
     N = np.prod(n)

     np.set_printoptions(precision=6)
     print(np.fft.fftn(np.reshape(np.cos(range(1, N+1)), n)))

     [[[-1.116736+0.j        0.168399+0.187682j  0.168399-0.187682j]
     [ 1.046712+0.j        9.437681-5.71589j   9.437681+5.71589j ]]

     [[ 0.012362+0.033962j -0.038003+0.148974j -0.163745+0.038803j]
     [-2.313028+2.269608j  0.416306-0.037628j -0.116759-1.044905j]]

     [[-0.010581+0.j       -0.095402+0.05778j  -0.095402-0.05778j ]
     [-2.24476 +0.j        0.338499+0.37726j   0.338499-0.37726j ]]

     [[ 0.012362-0.033962j -0.163745-0.038803j -0.038003-0.148974j]
     [-2.313028-2.269608j -0.116759+1.044905j  0.416306+0.037628j]]]

  */

  c_filter_new_idft(A);

  printf("\n");
  printf("idft(dft(A)):\n");
  c_filter_new_printf(A);

  c_filter_new_destroy(&A);



  /****************************************************************************/
  /* r_filter_new */

  printf("\n\n");
  puts("Test real filter:");
  puts("-----------------");


  rank = 3;

  n = malloc(rank * sizeof(int));
  assert(n);

  n_idx = malloc(rank * sizeof(int));
  assert(n_idx);

  n[0] = 5;
  n[1] = 3;
  n[2] = 4;

  n_idx[0] = 1;
  n_idx[1] = 1;
  n_idx[2] = 1;

  B = r_filter_new_create(rank, n);
  r_filter_new_set0(B);

  r_filter_new_init(B);

  printf("\n");
  printf("B:\n");
  r_filter_new_printf(B);

  e_ptr = r_filter_new_get_ptr(B, n_idx);

  printf("B[");
  for (i = 0; i < rank-1; i++) {
    printf("%d, ", n_idx[i]);
  }
  printf("%d] = ", n_idx[rank - 1]);
  printf_elem_n(*e_ptr);

  r_filter_new_dft(B);

  printf("\n");
  printf("dft(B):\n");
  r_filter_new_printf(B);

  printf("\n");
  printf("dft(B):\n");
  r_filter_new_printf_dft(B);

  /* Result:

     dft(B):
     (0, :, :)
     (-1.255183 +0.000000) (+1.806779 -0.738849) (+0.892947 +0.000000) (+1.806779 +0.738849)
     (+2.661063 -9.335989) (+5.779145 -0.348886) (+4.935864 +2.698994) (+6.028018 +15.986425)
     (+2.661063 +9.335989) (+6.028018 -15.986425) (+4.935864 -2.698994) (+5.779145 +0.348886)

     (1, :, :)
     (-0.326703 +0.954045) (+0.252432 +0.604715) (-0.408304 +0.203164) (-1.138467 -0.837248)
     (-7.293231 +4.012452) (-3.971155 -0.264325) (-2.497772 -3.662347) (+3.055664 -13.590208)
     (+0.012936 +3.869395) (+5.238268 -2.669956) (+1.619214 +0.904765) (-0.633193 +1.957131)

     (2, :, :)
     (-0.468626 +0.190794) (+0.039954 +0.474587) (-0.209401 +0.040630) (-0.238204 -0.521091)
     (-3.407534 -0.578338) (-1.400673 -0.825010) (-0.029327 -1.797684) (+4.216251 -3.807798)
     (-1.946419 +2.154579) (+4.652736 +0.556029) (+0.794004 +1.246212) (-0.733135 +1.163544)

     (3, :, :)
     (-0.468626 -0.190794) (-0.238204 +0.521091) (-0.209401 -0.040630) (+0.039954 -0.474587)
     (-1.946419 -2.154579) (-0.733135 -1.163544) (+0.794004 -1.246212) (+4.652736 -0.556029)
     (-3.407534 +0.578338) (+4.216251 +3.807798) (-0.029327 +1.797684) (-1.400673 +0.825010)

     (4, :, :)
     (-0.326703 -0.954045) (-1.138467 +0.837248) (-0.408304 -0.203164) (+0.252432 -0.604715)
     (+0.012936 -3.869395) (-0.633193 -1.957131) (+1.619214 -0.904765) (+5.238268 +2.669956)
     (-7.293231 -4.012452) (+3.055664 +13.590208) (-2.497772 +3.662347) (-3.971155 +0.264325)


     Matches Matlab:

     >> B = cos(permute(reshape(1:4*3*5, 4, 3, 5), [2 1 3]));
     >> fftn(B)

     ans(:,:,1) =

       -1.2552             1.8068 - 0.7388i   0.8929             1.8068 + 0.7388i
        2.6611 - 9.3360i   5.7791 - 0.3489i   4.9359 + 2.6990i   6.0280 +15.9864i
	2.6611 + 9.3360i   6.0280 -15.9864i   4.9359 - 2.6990i   5.7791 + 0.3489i


     ans(:,:,2) =

       -0.3267 + 0.9540i   0.2524 + 0.6047i  -0.4083 + 0.2032i  -1.1385 - 0.8372i
       -7.2932 + 4.0125i  -3.9712 - 0.2643i  -2.4978 - 3.6623i   3.0557 -13.5902i
        0.0129 + 3.8694i   5.2383 - 2.6700i   1.6192 + 0.9048i  -0.6332 + 1.9571i


     ans(:,:,3) =

       -0.4686 + 0.1908i   0.0400 + 0.4746i  -0.2094 + 0.0406i  -0.2382 - 0.5211i
       -3.4075 - 0.5783i  -1.4007 - 0.8250i  -0.0293 - 1.7977i   4.2163 - 3.8078i
       -1.9464 + 2.1546i   4.6527 + 0.5560i   0.7940 + 1.2462i  -0.7331 + 1.1635i


     ans(:,:,4) =

       -0.4686 - 0.1908i  -0.2382 + 0.5211i  -0.2094 - 0.0406i   0.0400 - 0.4746i
       -1.9464 - 2.1546i  -0.7331 - 1.1635i   0.7940 - 1.2462i   4.6527 - 0.5560i
       -3.4075 + 0.5783i   4.2163 + 3.8078i  -0.0293 + 1.7977i  -1.4007 + 0.8250i


     ans(:,:,5) =

       -0.3267 - 0.9540i  -1.1385 + 0.8372i  -0.4083 - 0.2032i   0.2524 - 0.6047i
        0.0129 - 3.8694i  -0.6332 - 1.9571i   1.6192 - 0.9048i   5.2383 + 2.6700i
       -7.2932 - 4.0125i   3.0557 +13.5902i  -2.4978 + 3.6623i  -3.9712 + 0.2643i


     Matches python:

     n = (5, 3, 4)
     N = np.prod(n)

     np.set_printoptions(precision=6)
     print(np.fft.fftn(np.reshape(np.cos(range(1, N+1)), n)))

     [[[-1.255183 +0.j        1.806778 -0.738849j  0.892947 +0.j
         1.806778 +0.738849j]
       [ 2.661063 -9.335989j  5.779145 -0.348886j  4.935864 +2.698994j
         6.028018+15.986426j]
       [ 2.661063 +9.335989j  6.028018-15.986426j  4.935864 -2.698994j
         5.779145 +0.348886j]]

      [[-0.326703 +0.954045j  0.252433 +0.604715j -0.408304 +0.203164j
        -1.138467 -0.837248j]
       [-7.293232 +4.012452j -3.971155 -0.264325j -2.497772 -3.662347j
         3.055664-13.590208j]
       [ 0.012936 +3.869395j  5.238268 -2.669956j  1.619214 +0.904765j
        -0.633193 +1.957132j]]

      [[-0.468626 +0.190794j  0.039954 +0.474588j -0.209401 +0.04063j
        -0.238204 -0.521091j]
       [-3.407534 -0.578337j -1.400673 -0.82501j  -0.029327 -1.797684j
         4.216251 -3.807798j]
       [-1.946419 +2.154579j  4.652737 +0.556029j  0.794004 +1.246212j
        -0.733135 +1.163544j]]

      [[-0.468626 -0.190794j -0.238204 +0.521091j -0.209401 -0.04063j
         0.039954 -0.474588j]
       [-1.946419 -2.154579j -0.733135 -1.163544j  0.794004 -1.246212j
         4.652737 -0.556029j]
       [-3.407534 +0.578337j  4.216251 +3.807798j -0.029327 +1.797684j
        -1.400673 +0.82501j ]]

      [[-0.326703 -0.954045j -1.138467 +0.837248j -0.408304 -0.203164j
         0.252433 -0.604715j]
       [ 0.012936 -3.869395j -0.633193 -1.957132j  1.619214 -0.904765j
         5.238268 +2.669956j]
       [-7.293232 -4.012452j  3.055664+13.590208j -2.497772 +3.662347j
        -3.971155 +0.264325j]]]

   */


  e_ptr = r_filter_new_get_ptr(B, n_idx);

  printf("dft(B)[");
  for (i = 0; i < rank-1; i++) {
    printf("%d, ", n_idx[i]);
  }
  printf("%d] = ", n_idx[rank - 1]);

  printf_z_elem_n((const z_elem *) e_ptr);


  free(n_idx);


  n2 = malloc(rank * sizeof(int));
  assert(n2);

  for (i = 0; i < rank; i++) {
    n2[i] = n[i];
  }

  B2 = r_filter_new_create(rank, n2);

  r_filter_new_init(B2);

  r_filter_new_dft(B2);
  r_filter_new_execute_r(B, B2);

  printf("\n");
  printf("DFT(B) .* DFT(B)\n");
  r_filter_new_printf_dft(B2);

  /* Result:

     DFT(B) .* DFT(B)
     (0, :, :)
       (+1.575484 +0.000000) (+2.718551 -2.669873) (+0.797354 +0.000000) (+2.718551 +2.669873)
       (-80.079437 -49.687309) (+33.276798 -4.032530) (+17.078186 +26.643732) (-219.228790 +192.732925)
       (-80.079437 +49.687309) (-219.228790 -192.732925) (+17.078186 -26.643732) (+33.276798 +4.032530)

     (1, :, :)
       (-0.803468 -0.623379) (-0.301958 +0.305299) (+0.125436 -0.165905) (+0.595123 +1.906360)
       (+37.091457 -58.527477) (+15.700206 +2.099349) (-7.173921 +18.295412) (-175.356674 -83.054214)
       (-14.972049 +0.100108) (+20.310785 -27.971889) (+1.803255 +2.930017) (-3.429430 -2.478482)

     (2, :, :)
       (+0.183208 -0.178822) (-0.223637 +0.037923) (+0.042198 -0.017016) (-0.214794 +0.248251)
       (+11.276813 +3.941410) (+1.281243 +2.311138) (-3.230808 +0.105441) (+3.277447 -32.109264)
       (-0.853664 -8.387424) (+21.338787 +5.174109) (-0.922603 +1.978995) (-0.816348 -1.706068)

     (3, :, :)
       (+0.183208 +0.178822) (-0.214794 -0.248251) (+0.042198 +0.017016) (-0.223637 -0.037923)
       (-0.853664 +8.387424) (-0.816348 +1.706068) (-0.922603 -1.978995) (+21.338787 -5.174109)
       (+11.276813 -3.941410) (+3.277447 +32.109264) (-3.230808 -0.105441) (+1.281243 -2.311138)

     (4, :, :)
       (-0.803468 +0.623379) (+0.595123 -1.906360) (+0.125436 +0.165905) (-0.301958 -0.305299)
       (-14.972049 -0.100108) (-3.429430 +2.478482) (+1.803255 -2.930017) (+20.310785 +27.971889)
       (+37.091457 +58.527477) (-175.356674 +83.054214) (-7.173921 -18.295412) (+15.700206 -2.099349)

     Matches Matlab:

     >> fftn(B).*fftn(B)

     ans(:,:,1) =

     1.0e+02 *

       0.0158             0.0272 - 0.0267i   0.0080             0.0272 + 0.0267i
      -0.8008 - 0.4969i   0.3328 - 0.0403i   0.1708 + 0.2664i  -2.1923 + 1.9273i
      -0.8008 + 0.4969i  -2.1923 - 1.9273i   0.1708 - 0.2664i   0.3328 + 0.0403i


     ans(:,:,2) =

     1.0e+02 *

      -0.0080 - 0.0062i  -0.0030 + 0.0031i   0.0013 - 0.0017i   0.0060 + 0.0191i
       0.3709 - 0.5853i   0.1570 + 0.0210i  -0.0717 + 0.1830i  -1.7536 - 0.8305i
      -0.1497 + 0.0010i   0.2031 - 0.2797i   0.0180 + 0.0293i  -0.0343 - 0.0248i


     ans(:,:,3) =

       0.1832 - 0.1788i  -0.2236 + 0.0379i   0.0422 - 0.0170i  -0.2148 + 0.2483i
      11.2768 + 3.9414i   1.2812 + 2.3111i  -3.2308 + 0.1054i   3.2775 -32.1093i
      -0.8537 - 8.3874i  21.3388 + 5.1741i  -0.9226 + 1.9790i  -0.8163 - 1.7061i


     ans(:,:,4) =

       0.1832 + 0.1788i  -0.2148 - 0.2483i   0.0422 + 0.0170i  -0.2236 - 0.0379i
      -0.8537 + 8.3874i  -0.8163 + 1.7061i  -0.9226 - 1.9790i  21.3388 - 5.1741i
      11.2768 - 3.9414i   3.2775 +32.1093i  -3.2308 - 0.1054i   1.2812 - 2.3111i


     ans(:,:,5) =

     1.0e+02 *

      -0.0080 + 0.0062i   0.0060 - 0.0191i   0.0013 + 0.0017i  -0.0030 - 0.0031i
      -0.1497 - 0.0010i  -0.0343 + 0.0248i   0.0180 - 0.0293i   0.2031 + 0.2797i
       0.3709 + 0.5853i  -1.7536 + 0.8305i  -0.0717 - 0.1830i   0.1570 - 0.0210i


     Matches python:

     B = np.reshape(np.cos(range(1, N+1)), n)
     print(np.fft.fftn(B) * np.fft.fftn(B))

     [[[ 1.575483e+00-0.000000e+00j  2.718550e+00-2.669874e+00j
         7.973545e-01+0.000000e+00j  2.718550e+00+2.669874e+00j]
       [-8.007944e+01-4.968732e+01j  3.327680e+01-4.032529e+00j
         1.707818e+01+2.664373e+01j -2.192288e+02+1.927329e+02j]
       [-8.007944e+01+4.968732e+01j -2.192288e+02-1.927329e+02j
         1.707818e+01-2.664373e+01j  3.327680e+01+4.032529e+00j]]

      [[-8.034677e-01-6.233792e-01j -3.019576e-01+3.052993e-01j
         1.254364e-01-1.659052e-01j  5.951228e-01+1.906360e+00j]
       [ 3.709146e+01-5.852748e+01j  1.570020e+01+2.099348e+00j
        -7.173919e+00+1.829541e+01j -1.753567e+02-8.305421e+01j]
       [-1.497205e+01+1.001086e-01j  2.031079e+01-2.797189e+01j
         1.803255e+00+2.930017e+00j -3.429432e+00-2.478483e+00j]]

      [[ 1.832080e-01-1.788217e-01j -2.236371e-01+3.792323e-02j
         4.219806e-02-1.701572e-02j -2.147945e-01+2.482513e-01j]
       [ 1.127681e+01+3.941407e+00j  1.281244e+00+2.311138e+00j
        -3.230808e+00+1.054400e-01j  3.277451e+00-3.210927e+01j]
       [-8.536648e-01-8.387424e+00j  2.133879e+01+5.174109e+00j
        -9.226031e-01+1.978995e+00j -8.163479e-01-1.706068e+00j]]

      [[ 1.832080e-01+1.788217e-01j -2.147945e-01-2.482513e-01j
         4.219806e-02+1.701572e-02j -2.236371e-01-3.792323e-02j]
       [-8.536648e-01+8.387424e+00j -8.163479e-01+1.706068e+00j
        -9.226031e-01-1.978995e+00j  2.133879e+01-5.174109e+00j]
       [ 1.127681e+01-3.941407e+00j  3.277451e+00+3.210927e+01j
        -3.230808e+00-1.054400e-01j  1.281244e+00-2.311138e+00j]]

      [[-8.034677e-01+6.233792e-01j  5.951228e-01-1.906360e+00j
         1.254364e-01+1.659052e-01j -3.019576e-01-3.052993e-01j]
       [-1.497205e+01-1.001086e-01j -3.429432e+00+2.478483e+00j
         1.803255e+00-2.930017e+00j  2.031079e+01+2.797189e+01j]
       [ 3.709146e+01+5.852748e+01j -1.753567e+02+8.305421e+01j
        -7.173919e+00-1.829541e+01j  1.570020e+01-2.099348e+00j]]]

   */

  r_filter_new_destroy(&B2);


  r_filter_new_idft(B);

  printf("\n");
  printf("idft(dft(B)):\n");
  r_filter_new_printf(B);

  r_filter_new_export("/tmp/B_filter_new_test", B);

  B2 = r_filter_new_import("/tmp/B_filter_new_test");

  printf("\n");
  printf("B:\n");
  r_filter_new_printf(B2);

  r_filter_new_destroy(&B);
  r_filter_new_destroy(&B2);


  /****************************************************************************/
  /* rs2_filter_new */

  printf("\n\n");
  puts("Test real symmetric type-II filter:");
  puts("-----------------------------------");

  rank = 3;

  n_phy = malloc(rank * sizeof(int));
  assert(n_phy);

  n_phy[0] = 2;
  n_phy[1] = 3;
  n_phy[2] = 4;

  C = rs2_filter_new_create(rank, n_phy);

  for (i = 0; i < C->N_phy; i++) {
    C->h[i] = cos(i + 1);
  }

  printf("\n");
  printf("phy=%d\tlog=%d\n", C->N_phy, C->N_log);
  printf("C:\n");
  rs2_filter_new_printf(C);

  rs2_filter_new_dft(C);

  printf("\n");
  printf("dft(C):\n");
  rs2_filter_new_printf(C);

  printf("\n");
  printf("dft(C):\n");
  rs2_filter_new_printf_dft(C);

  /* Result:

     dft(C):
     (0, :, :)
     (-8.933886 +0.000000) (+0.639278 +0.264798) (+3.800545 +3.800545) (-0.014667 -0.035408) (+0.000000 +0.000000) (-0.014667 +0.035408) (+3.800545 -3.800545) (+0.639278 -0.264798)
     (+2.193733 +1.266553) (+27.033772 +35.231098) (-0.394430 -1.472032) (+0.321056 -2.438659) (+0.000000 +0.000000) (-1.951413 +1.497372) (-1.472032 +0.394430) (+44.027912 +5.796382)
     (-24.038517 -41.635937) (+0.486038 +3.691826) (-7.486081 +27.938427) (+0.125558 -0.163630) (+0.000000 +0.000000) (-0.204486 +0.026921) (+27.938427 +7.486081) (+2.954196 +2.266834)
     (+0.000000 +0.000000) (+0.000000 +0.000000) (+0.000000 +0.000000) (+0.000000 +0.000000) (+0.000000 +0.000000) (+0.000000 +0.000000) (+0.000000 +0.000000) (+0.000000 +0.000000)
     (-24.038523 +41.635937) (+2.954196 -2.266834) (+27.938427 -7.486077) (-0.204486 -0.026921) (+0.000000 +0.000000) (+0.125558 +0.163630) (-7.486077 -27.938427) (+0.486038 -3.691826)
     (+2.193733 -1.266553) (+44.027916 -5.796386) (-1.472032 -0.394430) (-1.951413 -1.497372) (+0.000000 +0.000000) (+0.321056 +2.438659) (-0.394430 +1.472032) (+27.033772 -35.231106)

     (1, :, :)
     (-0.086402 -0.086402) (-0.819762 -1.979081) (+0.000000 +0.073513) (-0.045406 +0.109619) (+0.000000 +0.000000) (+0.109619 -0.045406) (+0.073513 +0.000000) (-1.979081 -0.819762)
     (-2.029656 -7.574780) (-0.079279 +0.602184) (-2.358939 +4.085803) (+0.026690 -0.020480) (+0.000000 +0.000000) (-0.033355 -0.004391) (+4.085803 +2.358939) (+0.369749 +0.481867)
     (+0.170191 -0.635160) (+7.017666 -9.145599) (-0.342602 +0.197801) (-0.633049 +0.083342) (+0.000000 +0.000000) (+0.506565 +0.388701) (+0.197801 +0.342602) (-1.504677 -11.429155)
     (+0.000000 +0.000000) (+0.000000 +0.000000) (+0.000000 +0.000000) (+0.000000 +0.000000) (+0.000000 +0.000000) (+0.000000 +0.000000) (+0.000000 +0.000000) (+0.000000 +0.000000)
     (-0.635160 +0.170191) (-11.429154 -1.504678) (+0.342602 +0.197801) (+0.388701 +0.506565) (+0.000000 +0.000000) (+0.083342 -0.633049) (+0.197801 -0.342602) (-9.145600 +7.017666)
     (-7.574780 -2.029656) (+0.481867 +0.369749) (+2.358939 +4.085802) (-0.004391 -0.033355) (+0.000000 +0.000000) (-0.020480 +0.026690) (+4.085802 -2.358939) (+0.602184 -0.079279)

     (2, :, :)
     (+0.000000 +0.000000) (+0.000000 +0.000000) (+0.000000 +0.000000) (+0.000000 +0.000000) (+0.000000 +0.000000) (+0.000000 +0.000000) (+0.000000 +0.000000) (+0.000000 +0.000000)
     (+0.000000 +0.000000) (+0.000000 +0.000000) (+0.000000 +0.000000) (+0.000000 +0.000000) (+0.000000 +0.000000) (+0.000000 +0.000000) (+0.000000 +0.000000) (+0.000000 +0.000000)
     (+0.000000 +0.000000) (+0.000000 +0.000000) (+0.000000 +0.000000) (+0.000000 +0.000000) (+0.000000 +0.000000) (+0.000000 +0.000000) (+0.000000 +0.000000) (+0.000000 +0.000000)
     (+0.000000 +0.000000) (+0.000000 +0.000000) (+0.000000 +0.000000) (+0.000000 +0.000000) (+0.000000 +0.000000) (+0.000000 +0.000000) (+0.000000 +0.000000) (+0.000000 +0.000000)
     (+0.000000 +0.000000) (+0.000000 +0.000000) (+0.000000 +0.000000) (+0.000000 +0.000000) (+0.000000 +0.000000) (+0.000000 +0.000000) (+0.000000 +0.000000) (+0.000000 +0.000000)
     (+0.000000 +0.000000) (+0.000000 +0.000000) (+0.000000 +0.000000) (+0.000000 +0.000000) (+0.000000 +0.000000) (+0.000000 +0.000000) (+0.000000 +0.000000) (+0.000000 +0.000000)

     (3, :, :)
     (-0.086402 +0.086402) (-1.979081 +0.819762) (+0.073513 +0.000000) (+0.109619 +0.045406) (+0.000000 +0.000000) (-0.045406 -0.109619) (+0.000000 -0.073513) (-0.819762 +1.979081)
     (-7.574780 +2.029656) (+0.602184 +0.079279) (+4.085803 +2.358939) (-0.020480 -0.026690) (+0.000000 +0.000000) (-0.004391 +0.033355) (+2.358939 -4.085803) (+0.481867 -0.369749)
     (-0.635160 -0.170191) (-9.145599 -7.017666) (+0.197801 +0.342602) (+0.083342 +0.633049) (+0.000000 +0.000000) (+0.388701 -0.506565) (+0.342602 -0.197801) (-11.429155 +1.504677)
     (+0.000000 +0.000000) (+0.000000 +0.000000) (+0.000000 +0.000000) (+0.000000 +0.000000) (+0.000000 +0.000000) (+0.000000 +0.000000) (+0.000000 +0.000000) (+0.000000 +0.000000)
     (+0.170191 +0.635160) (-1.504678 +11.429154) (+0.197801 -0.342602) (+0.506565 -0.388701) (+0.000000 +0.000000) (-0.633049 -0.083342) (-0.342602 -0.197801) (+7.017666 +9.145600)
     (-2.029656 +7.574780) (+0.369749 -0.481867) (+4.085802 -2.358939) (-0.033355 +0.004391) (+0.000000 +0.000000) (+0.026690 +0.020480) (-2.358939 -4.085802) (-0.079279 -0.602184)


     Matches Matlab:

     >> Ys = cos(reshape(1:3*4,4,3)');
     >> Y1 = [Ys, fliplr(Ys)];
     >> Y = [Y1; flipud(Y1)];
     >> Zs = cos(reshape((1:3*4) + 3*4,4,3)');
     >> Z1 = [Zs, fliplr(Zs)];
     >> Z = [Z1; flipud(Z1)];
     >> C = cat(3,Y,Z,Z,Y);
     >> fftn(C)

     ans(:,:,1) =

     Columns 1 through 6

       -8.9339             0.6393 + 0.2648i   3.8005 + 3.8005i  -0.0147 - 0.0354i        0            -0.0147 + 0.0354i
        2.1937 + 1.2666i  27.0338 +35.2311i  -0.3944 - 1.4720i   0.3211 - 2.4387i        0            -1.9514 + 1.4974i
      -24.0385 -41.6359i   0.4860 + 3.6918i  -7.4861 +27.9384i   0.1256 - 0.1636i        0            -0.2045 + 0.0269i
        0                  0                  0                  0                  0                  0
      -24.0385 +41.6359i   2.9542 - 2.2668i  27.9384 - 7.4861i  -0.2045 - 0.0269i        0             0.1256 + 0.1636i
        2.1937 - 1.2666i  44.0279 - 5.7964i  -1.4720 - 0.3944i  -1.9514 - 1.4974i        0             0.3211 + 2.4387i

     Columns 7 through 8

        3.8005 - 3.8005i   0.6393 - 0.2648i
       -1.4720 + 0.3944i  44.0279 + 5.7964i
       27.9384 + 7.4861i   2.9542 + 2.2668i
        0                  0
       -7.4861 -27.9384i   0.4860 - 3.6918i
       -0.3944 + 1.4720i  27.0338 -35.2311i


     ans(:,:,2) =

     Columns 1 through 6

       -0.0864 - 0.0864i  -0.8198 - 1.9791i        0 + 0.0735i  -0.0454 + 0.1096i        0             0.1096 - 0.0454i
       -2.0297 - 7.5748i  -0.0793 + 0.6022i  -2.3589 + 4.0858i   0.0267 - 0.0205i        0            -0.0334 - 0.0044i
        0.1702 - 0.6352i   7.0177 - 9.1456i  -0.3426 + 0.1978i  -0.6330 + 0.0833i        0             0.5066 + 0.3887i
        0                  0                  0                  0                  0                  0
       -0.6352 + 0.1702i -11.4292 - 1.5047i   0.3426 + 0.1978i   0.3887 + 0.5066i        0             0.0833 - 0.6330i
       -7.5748 - 2.0297i   0.4819 + 0.3697i   2.3589 + 4.0858i  -0.0044 - 0.0334i        0            -0.0205 + 0.0267i

     Columns 7 through 8

        0.0735            -1.9791 - 0.8198i
	4.0858 + 2.3589i   0.3697 + 0.4819i
	0.1978 + 0.3426i  -1.5047 -11.4292i
        0                  0
	0.1978 - 0.3426i  -9.1456 + 7.0177i
	4.0858 - 2.3589i   0.6022 - 0.0793i


     ans(:,:,3) =

        0     0     0     0     0     0     0     0
	0     0     0     0     0     0     0     0
	0     0     0     0     0     0     0     0
	0     0     0     0     0     0     0     0
	0     0     0     0     0     0     0     0
	0     0     0     0     0     0     0     0


     ans(:,:,4) =

     Columns 1 through 6

       -0.0864 + 0.0864i  -1.9791 + 0.8198i   0.0735             0.1096 + 0.0454i        0            -0.0454 - 0.1096i
       -7.5748 + 2.0297i   0.6022 + 0.0793i   4.0858 + 2.3589i  -0.0205 - 0.0267i        0            -0.0044 + 0.0334i
       -0.6352 - 0.1702i  -9.1456 - 7.0177i   0.1978 + 0.3426i   0.0833 + 0.6330i        0             0.3887 - 0.5066i
        0                  0                  0                  0                  0                  0
        0.1702 + 0.6352i  -1.5047 +11.4292i   0.1978 - 0.3426i   0.5066 - 0.3887i        0            -0.6330 - 0.0833i
       -2.0297 + 7.5748i   0.3697 - 0.4819i   4.0858 - 2.3589i  -0.0334 + 0.0044i        0             0.0267 + 0.0205i

     Columns 7 through 8

        0 - 0.0735i  -0.8198 + 1.9791i
        2.3589 - 4.0858i   0.4819 - 0.3697i
	0.3426 - 0.1978i -11.4292 + 1.5047i
        0                  0
       -0.3426 - 0.1978i   7.0177 + 9.1456i
       -2.3589 - 4.0858i  -0.0793 - 0.6022i

   */


  rs2_filter_new_idft(C);

  printf("\n");
  printf("idft(dft(C)):\n");
  rs2_filter_new_printf(C);

  n = malloc(rank * sizeof(int));
  assert(n);

  for (i = 0; i < rank; i++) {
    n[i] = 2*n_phy[i];
  }

  B = r_filter_new_create(rank, n);
  r_filter_new_init(B);

  printf("B:\n");
  r_filter_new_printf(B);

  r_filter_new_dft(B);
  rs2_filter_new_dft(C);

  rs2_filter_new_execute_r(C, B);

  r_filter_new_idft(B);

  printf("\n");
  printf("idft(dft(B) .* dft(C)):\n");
  r_filter_new_printf(B);

  /* Result:

     idft(dft(B) .* dft(C)):
     (0, :, :)
     -6.488801 -3.356272 -0.409407 +6.566419 +10.163670 +2.671263 -8.227259 -10.843208
     +7.341193 +8.018958 +8.488239 +4.240737 -3.608457 -6.608031 -2.001038 +4.568274
     +5.121900 +3.056361 -1.544098 -8.448786 -10.092029 -3.368573 +4.252739 +6.499509
     +0.840405 -1.844687 -5.188202 -2.721628 +1.798735 +1.275596 -1.573102 -0.831445
     +1.623460 +0.561350 +2.359687 +2.718175 +0.622830 +0.532638 +3.318235 +4.112049
     -7.925041 -5.912834 -2.893856 -0.683301 +2.504194 +5.167766 +2.917855 -3.968479

     (1, :, :)
     -4.683082 -8.519258 -10.506950 -3.571885 +6.203279 +7.583501 +2.208668 -2.270443
     -1.330338 +6.338421 +14.003932 +14.691775 +5.749113 -5.167263 -9.939515 -7.379741
     +11.888750 +8.360970 -0.106843 -9.734420 -13.450106 -8.524651 +0.482584 +8.712485
     +4.321078 -6.931341 -15.074551 -10.502653 +0.469962 +6.725677 +8.793797 +9.218604
     -7.951766 -0.592495 +10.532982 +14.473795 +8.896088 +1.786615 -2.827785 -7.018396
     -3.736839 -0.157862 +0.989806 -3.021632 -4.569813 -0.712949 +1.009185 -2.415218

     (2, :, :)
     +1.634221 +0.221362 -2.972852 -1.672173 +1.063514 -0.797052 -3.894845 -1.922099
     -0.217983 +0.902306 +4.648349 +5.609743 +2.412377 +0.173499 +0.949768 +1.106962
     +3.925806 +5.733153 +2.402142 -4.933448 -8.786125 -6.451497 -2.745092 +0.448522
     +10.078662 +1.342804 -9.763184 -11.391303 -5.809758 -1.914894 +1.350394 +7.819507
     -5.062387 -6.246988 -0.059589 +6.534507 +8.174458 +7.643491 +7.062984 +2.184454
     -9.363039 -2.537584 +4.484536 +5.710446 +3.849228 +2.136338 -1.877117 -8.215592

     (3, :, :)
     -0.171499 +5.384349 +7.124692 +8.466131 +5.023905 -5.709290 -14.330772 -10.494865
     +8.453548 +2.582844 -0.867345 -4.841294 -6.945192 -1.267270 +8.888245 +13.054976
     -2.841044 +0.428543 +0.964887 -3.647814 -5.428049 -1.295418 +1.025064 -1.764453
     +6.597988 +6.429459 +0.123165 -3.610278 -4.480986 -7.364975 -9.016504 -2.230542
     +4.512838 -5.093143 -8.232883 -5.221112 -0.098800 +6.389514 +13.209002 +13.314898
     -13.551242 -8.292555 +0.600874 +8.048778 +10.923236 +8.017053 +0.031554 -9.768854

     Matches Matlab:

     >> B = cos(permute(reshape(1:(2*4)*(2*3)*(2*2), 2*4, 2*3, 2*2), [2 1 3]));
     >> Ys = cos(reshape(1:3*4,4,3)');
     >> Y1 = [Ys, fliplr(Ys)];
     >> Y = [Y1; flipud(Y1)];
     >> Zs = cos(reshape((1:3*4) + 3*4,4,3)');
     >> Z1 = [Zs, fliplr(Zs)];
     >> Z = [Z1; flipud(Z1)];
     >> C = cat(3,Y,Z,Z,Y);
     >> ifftn(fftn(B).*fftn(C))

     ans(:,:,1) =

       -6.4888   -3.3563   -0.4094    6.5664   10.1637    2.6713   -8.2273  -10.8432
        7.3412    8.0190    8.4882    4.2407   -3.6085   -6.6080   -2.0010    4.5683
	5.1219    3.0564   -1.5441   -8.4488  -10.0920   -3.3686    4.2527    6.4995
	0.8404   -1.8447   -5.1882   -2.7216    1.7987    1.2756   -1.5731   -0.8314
	1.6235    0.5613    2.3597    2.7182    0.6228    0.5326    3.3182    4.1121
       -7.9250   -5.9128   -2.8939   -0.6833    2.5042    5.1678    2.9179   -3.9685


     ans(:,:,2) =

       -4.6831   -8.5193  -10.5070   -3.5719    6.2033    7.5835    2.2087   -2.2704
       -1.3303    6.3384   14.0039   14.6918    5.7491   -5.1673   -9.9395   -7.3797
       11.8887    8.3610   -0.1068   -9.7344  -13.4501   -8.5247    0.4826    8.7125
        4.3211   -6.9313  -15.0746  -10.5027    0.4700    6.7257    8.7938    9.2186
       -7.9518   -0.5925   10.5330   14.4738    8.8961    1.7866   -2.8278   -7.0184
       -3.7368   -0.1579    0.9898   -3.0216   -4.5698   -0.7130    1.0092   -2.4152


     ans(:,:,3) =

        1.6342    0.2214   -2.9729   -1.6722    1.0635   -0.7971   -3.8948   -1.9221
       -0.2180    0.9023    4.6483    5.6097    2.4124    0.1735    0.9498    1.1070
        3.9258    5.7332    2.4021   -4.9334   -8.7861   -6.4515   -2.7451    0.4485
       10.0787    1.3428   -9.7632  -11.3913   -5.8098   -1.9149    1.3504    7.8195
       -5.0624   -6.2470   -0.0596    6.5345    8.1745    7.6435    7.0630    2.1845
       -9.3630   -2.5376    4.4845    5.7104    3.8492    2.1363   -1.8771   -8.2156


     ans(:,:,4) =

       -0.1715    5.3843    7.1247    8.4661    5.0239   -5.7093  -14.3308  -10.4949
        8.4536    2.5828   -0.8673   -4.8413   -6.9452   -1.2673    8.8882   13.0550
       -2.8410    0.4285    0.9649   -3.6478   -5.4281   -1.2954    1.0251   -1.7645
        6.5980    6.4295    0.1232   -3.6103   -4.4810   -7.3650   -9.0165   -2.2305
	4.5128   -5.0931   -8.2329   -5.2211   -0.0988    6.3895   13.2090   13.3149
      -13.5512   -8.2926    0.6009    8.0488   10.9232    8.0171    0.0316   -9.7689

   */

  r_filter_new_destroy(&B);

  rs2_filter_new_idft(C);
  rs2_filter_new_export("/tmp/C_filter_new_test", C);

  rs2_filter_new_destroy(&C);

  D = rs2_filter_new_import("/tmp/C_filter_new_test");

  printf("\n");
  printf("D:\n");
  rs2_filter_new_printf(D);

  rs2_filter_new_destroy(&D);



  /****************************************************************************/
  /* rs12_filter_new */


  //rank = 2;
  rank = 3;

  n_phy = malloc(rank * sizeof(int));
  assert(n_phy);

  n_phy[0] = 3;
  n_phy[1] = 2;
  n_phy[2] = 4;

  kind = malloc(rank * sizeof(rs12_filter_new_kind));
  assert(kind);

  kind[0] = TYPE2;
  kind[1] = TYPE2;
  kind[2] = TYPE1;

  //n_phy[0] = 3;
  //n_phy[1] = 4;

  //kind[0] = TYPE2;
  //kind[1] = TYPE1;

  E = rs12_filter_new_create(rank, n_phy, kind);

  for (i = 0; i < E->N_phy; i++) {
    E->h[i] = cos(i + 1);
  }

  printf("\n");
  printf("E:\n");
  rs12_filter_new_printf(E);

  rs12_filter_new_dft(E);

  printf("\n");
  printf("dft(E):\n");
  rs12_filter_new_printf_dft(E);

  /* Result:

     dft(E):
     (0, :, :)
     (-8.600685 +0.000000) (+0.462408 +0.000000) (+3.800545 +0.000000) (+0.012099 +0.000000) (+3.800545 +0.000000) (+0.462408 +0.000000)
     (-0.624563 -0.624563) (-7.600498 -7.600498) (+0.275988 +0.275988) (-0.198869 -0.198869) (+0.275988 +0.275988) (-7.600498 -7.600498)
     (+0.000000 +0.000000) (+0.000000 +0.000000) (+0.000000 +0.000000) (+0.000000 +0.000000) (+0.000000 +0.000000) (+0.000000 +0.000000)
     (-0.624563 +0.624563) (-7.600498 +7.600498) (+0.275988 -0.275988) (-0.198869 +0.198869) (+0.275988 -0.275988) (-7.600498 +7.600498)

     (1, :, :)
     (+1.196592 +0.690853) (+14.561672 +8.407186) (-0.528760 -0.305280) (+0.381009 +0.219976) (-0.528760 -0.305280) (+14.561672 +8.407186)
     (-8.312691 -31.023384) (+0.446926 +1.667950) (+3.673283 +13.708879) (+0.011694 +0.043642) (+3.673283 +13.708879) (+0.446926 +1.667950)
     (+0.000000 +0.000000) (+0.000000 +0.000000) (+0.000000 +0.000000) (+0.000000 +0.000000) (+0.000000 +0.000000) (+0.000000 +0.000000)
     (-31.023384 +8.312691) (+1.667950 -0.446926) (+13.708879 -3.673283) (+0.043642 -0.011694) (+13.708879 -3.673283) (+1.667950 -0.446926)

     (2, :, :)
     (+6.947874 +12.034072) (-0.373548 -0.647004) (-3.070186 -5.317719) (-0.009774 -0.016929) (-3.070186 -5.317719) (-0.373548 -0.647004)
     (-0.369349 +1.378429) (-4.494716 +16.774504) (+0.163211 -0.609111) (-0.117605 +0.438908) (+0.163211 -0.609111) (-4.494716 +16.774504)
     (+0.000000 +0.000000) (+0.000000 +0.000000) (+0.000000 +0.000000) (+0.000000 +0.000000) (+0.000000 +0.000000) (+0.000000 +0.000000)
     (+1.378429 +0.369349) (+16.774504 +4.494716) (-0.609111 -0.163211) (+0.438908 +0.117605) (-0.609111 -0.163211) (+16.774504 +4.494716)

     (3, :, :)
     (+0.000000 +0.000000) (+0.000000 +0.000000) (+0.000000 +0.000000) (+0.000000 +0.000000) (+0.000000 +0.000000) (+0.000000 +0.000000)
     (+0.000000 +0.000000) (+0.000000 +0.000000) (+0.000000 +0.000000) (+0.000000 +0.000000) (+0.000000 +0.000000) (+0.000000 +0.000000)
     (+0.000000 +0.000000) (+0.000000 +0.000000) (+0.000000 +0.000000) (+0.000000 +0.000000) (+0.000000 +0.000000) (+0.000000 +0.000000)
     (+0.000000 +0.000000) (+0.000000 +0.000000) (+0.000000 +0.000000) (+0.000000 +0.000000) (+0.000000 +0.000000) (+0.000000 +0.000000)

     (4, :, :)
     (+6.947875 -12.034072) (-0.373548 +0.647004) (-3.070187 +5.317719) (-0.009774 +0.016929) (-3.070187 +5.317719) (-0.373548 +0.647004)
     (+1.378429 -0.369349) (+16.774504 -4.494714) (-0.609111 +0.163211) (+0.438908 -0.117605) (-0.609111 +0.163211) (+16.774504 -4.494714)
     (+0.000000 +0.000000) (+0.000000 +0.000000) (+0.000000 +0.000000) (+0.000000 +0.000000) (+0.000000 +0.000000) (+0.000000 +0.000000)
     (-0.369349 -1.378429) (-4.494714 -16.774504) (+0.163211 +0.609111) (-0.117605 -0.438908) (+0.163211 +0.609111) (-4.494714 -16.774504)

     (5, :, :)
     (+1.196592 -0.690853) (+14.561672 -8.407187) (-0.528760 +0.305280) (+0.381009 -0.219976) (-0.528760 +0.305280) (+14.561672 -8.407187)
     (-31.023384 -8.312689) (+1.667950 +0.446926) (+13.708879 +3.673282) (+0.043642 +0.011694) (+13.708879 +3.673282) (+1.667950 +0.446926)
     (+0.000000 +0.000000) (+0.000000 +0.000000) (+0.000000 +0.000000) (+0.000000 +0.000000) (+0.000000 +0.000000) (+0.000000 +0.000000)
     (-8.312689 +31.023384) (+0.446926 -1.667950) (+3.673282 -13.708879) (+0.011694 -0.043642) (+3.673282 -13.708879) (+0.446926 -1.667950)

     Matches Matlab:

     >> n_phy = [3 2 4];
     >> E1 = reshape(cos(1:n_phy(3)*n_phy(2)), 4, 2)';
     >> E1 = [E1, fliplr(E1(:, 2:n_phy(3)-1))];
     >> E1 = [E1; flipud(E1)];
     >> E2 = reshape(cos((1:n_phy(3)*n_phy(2))+n_phy(2)*n_phy(3)), 4, 2)'
     >> E2 = [E2, fliplr(E2(:, 2:n_phy(3)-1))];
     >> E2 = [E2; flipud(E2)];
     >> E3 = reshape(cos((1:n_phy(3)*n_phy(2))+2*n_phy(2)*n_phy(3)), 4, 2)';
     >> E3 = [E3, fliplr(E3(:, 2:n_phy(3)-1))];
     >> E3 = [E3; flipud(E3)];
     >> E4(:,:,1) = E1;
     >> E4(:,:,2) = E2;
     >> E4(:,:,3) = E3;
     >> E4(:,:,4:6) = E4(:,:,n_phy(1):-1:1);
     >> fftn(E4)

     ans(:,:,1) =

       -8.6007             0.4624             3.8005             0.0121             3.8005             0.4624
       -0.6246 - 0.6246i  -7.6005 - 7.6005i   0.2760 + 0.2760i  -0.1989 - 0.1989i   0.2760 + 0.2760i  -7.6005 - 7.6005i
        0                  0                  0                  0                  0                  0
       -0.6246 + 0.6246i  -7.6005 + 7.6005i   0.2760 - 0.2760i  -0.1989 + 0.1989i   0.2760 - 0.2760i  -7.6005 + 7.6005i


     ans(:,:,2) =

        1.1966 + 0.6909i  14.5617 + 8.4072i  -0.5288 - 0.3053i   0.3810 + 0.2200i  -0.5288 - 0.3053i  14.5617 + 8.4072i
       -8.3127 -31.0234i   0.4469 + 1.6679i   3.6733 +13.7089i   0.0117 + 0.0436i   3.6733 +13.7089i   0.4469 + 1.6679i
        0                  0                  0                  0                  0                  0
 -31.0234 + 8.3127i   1.6679 - 0.4469i  13.7089 - 3.6733i   0.0436 - 0.0117i  13.7089 - 3.6733i   1.6679 - 0.4469i


ans(:,:,3) =

   6.9479 +12.0341i  -0.3735 - 0.6470i  -3.0702 - 5.3177i  -0.0098 - 0.0169i  -3.0702 - 5.3177i  -0.3735 - 0.6470i
  -0.3693 + 1.3784i  -4.4947 +16.7745i   0.1632 - 0.6091i  -0.1176 + 0.4389i   0.1632 - 0.6091i  -4.4947 +16.7745i
        0                  0                  0                  0                  0                  0
   1.3784 + 0.3693i  16.7745 + 4.4947i  -0.6091 - 0.1632i   0.4389 + 0.1176i  -0.6091 - 0.1632i  16.7745 + 4.4947i


ans(:,:,4) =

     0     0     0     0     0     0
     0     0     0     0     0     0
     0     0     0     0     0     0
     0     0     0     0     0     0


ans(:,:,5) =

   6.9479 -12.0341i  -0.3735 + 0.6470i  -3.0702 + 5.3177i  -0.0098 + 0.0169i  -3.0702 + 5.3177i  -0.3735 + 0.6470i
   1.3784 - 0.3693i  16.7745 - 4.4947i  -0.6091 + 0.1632i   0.4389 - 0.1176i  -0.6091 + 0.1632i  16.7745 - 4.4947i
        0                  0                  0                  0                  0                  0
  -0.3693 - 1.3784i  -4.4947 -16.7745i   0.1632 + 0.6091i  -0.1176 - 0.4389i   0.1632 + 0.6091i  -4.4947 -16.7745i


ans(:,:,6) =

   1.1966 - 0.6909i  14.5617 - 8.4072i  -0.5288 + 0.3053i   0.3810 - 0.2200i  -0.5288 + 0.3053i  14.5617 - 8.4072i
 -31.0234 - 8.3127i   1.6679 + 0.4469i  13.7089 + 3.6733i   0.0436 + 0.0117i  13.7089 + 3.6733i   1.6679 + 0.4469i
        0                  0                  0                  0                  0                  0
  -8.3127 +31.0234i   0.4469 - 1.6679i   3.6733 -13.7089i   0.0117 - 0.0436i   3.6733 -13.7089i   0.4469 - 1.6679i

   */

  rs12_filter_new_idft(E);

  printf("\n");
  printf("idft(dft(E)):\n");
  rs12_filter_new_printf(E);

  n = malloc(rank * sizeof(int));
  assert(n);

  for (i = 0; i < rank; i++) {
    n[i] = E->n_log[i];
  }

  B = r_filter_new_create(rank, n);
  r_filter_new_init(B);

  printf("\n");
  printf("B:\n");
  r_filter_new_printf(B);

  r_filter_new_dft(B);

  rs12_filter_new_dft(E);

  rs12_filter_new_execute_r(E, B);

  r_filter_new_idft(B);

  printf("\n");
  printf("idft(dft(B) .* dft(E)):\n");
  r_filter_new_printf(B);

  /* Result:

     idft(dft(B) .* dft(E)):
     (0, :, :)
     +14.850584 +11.179072 -3.090208 -14.404077 -10.532065 +4.408693
     +15.015769 +10.981856 -3.941989 -14.814867 -10.901487 +3.960327
     +14.992893 +10.765357 -4.796380 -15.434915 -11.450189 +3.370224
     +14.827711 +10.962575 -3.944600 -15.024128 -11.080770 +3.818591

     (1, :, :)
     +5.299742 +15.553772 +11.089523 -3.972331 -14.622623 -9.876819
     +3.392790 +15.106214 +11.730501 -3.474544 -15.122399 -11.692904
     +1.293600 +14.286862 +12.266076 -2.837801 -15.163571 -13.113484
     +3.200552 +14.734419 +11.625096 -3.335588 -14.663793 -11.297397

     (2, :, :)
     -9.828860 +5.653410 +15.882543 +11.071975 -5.203030 -15.897046
     -11.504015 +4.150290 +15.716125 +11.578032 -4.088534 -15.621677
     -12.740203 +2.692863 +15.401158 +11.984888 -2.736252 -14.764206
     -11.065052 +4.195984 +15.567578 +11.478833 -3.850749 -15.039578

     (3, :, :)
     -15.416951 -10.250183 +4.688090 +15.274793 +9.719890 -5.992538
     -14.918154 -10.984248 +3.935139 +15.013576 +11.011838 -3.955297
     -13.853977 -11.276901 +3.229360 +14.580748 +12.059645 -1.820856
     -14.352773 -10.542836 +3.982309 +14.841963 +10.767695 -3.858096

     (4, :, :)
     -4.168040 -15.796794 -12.481671 +2.649726 +14.846034 +11.406369
     -3.448545 -15.048283 -11.624669 +3.352298 +15.055234 +11.739874
     -2.785086 -14.397014 -10.883892 +4.166319 +15.274972 +11.897672
     -3.504581 -15.145527 -11.740895 +3.463748 +15.065774 +11.564168

     (5, :, :)
     +10.970894 -4.267900 -15.466949 -11.984837 +4.013671 +15.787373
     +11.588573 -4.038101 -15.516171 -11.423567 +4.175772 +15.726726
     +12.027982 -3.948753 -15.774549 -11.026654 +4.192456 +15.438027
     +11.410300 -4.178551 -15.725325 -11.587921 +4.030354 +15.498674

     Matches Matlab:

     >> S = size(E4);
     >> S = [S(2), S(1), S(3)]
     >> B = cos(permute(reshape(1:prod(S), S), [2 1 3]));
     >> ifftn(fftn(B) .* fftn(E4))

     ans(:,:,1) =

        14.8506   11.1791   -3.0902  -14.4041  -10.5321    4.4087
	15.0158   10.9819   -3.9420  -14.8149  -10.9015    3.9603
	14.9929   10.7654   -4.7964  -15.4349  -11.4502    3.3702
	14.8277   10.9626   -3.9446  -15.0241  -11.0808    3.8186


     ans(:,:,2) =

        5.2997   15.5538   11.0895   -3.9723  -14.6226   -9.8768
	3.3928   15.1062   11.7305   -3.4745  -15.1224  -11.6929
	1.2936   14.2869   12.2661   -2.8378  -15.1636  -13.1135
	3.2006   14.7344   11.6251   -3.3356  -14.6638  -11.2974


     ans(:,:,3) =

       -9.8289    5.6534   15.8825   11.0720   -5.2030  -15.8971
      -11.5040    4.1503   15.7161   11.5780   -4.0885  -15.6217
      -12.7402    2.6929   15.4012   11.9849   -2.7363  -14.7642
      -11.0651    4.1960   15.5676   11.4788   -3.8508  -15.0396


     ans(:,:,4) =

      -15.4170  -10.2502    4.6881   15.2748    9.7199   -5.9925
      -14.9182  -10.9842    3.9351   15.0136   11.0118   -3.9553
      -13.8540  -11.2769    3.2294   14.5807   12.0596   -1.8209
      -14.3528  -10.5428    3.9823   14.8420   10.7677   -3.8581


     ans(:,:,5) =

       -4.1680  -15.7968  -12.4817    2.6497   14.8460   11.4064
       -3.4485  -15.0483  -11.6247    3.3523   15.0552   11.7399
       -2.7851  -14.3970  -10.8839    4.1663   15.2750   11.8977
       -3.5046  -15.1455  -11.7409    3.4637   15.0658   11.5642


     ans(:,:,6) =

       10.9709   -4.2679  -15.4670  -11.9848    4.0137   15.7874
       11.5886   -4.0381  -15.5162  -11.4236    4.1758   15.7267
       12.0280   -3.9488  -15.7746  -11.0267    4.1925   15.4380
       11.4103   -4.1786  -15.7253  -11.5879    4.0304   15.4987

   */

  r_filter_new_destroy(&B);

  rs12_filter_new_idft(E);
  rs12_filter_new_export("/tmp/E_filter_new_test", E);

  rs12_filter_new_set0(E);

  rs12_filter_new_destroy(&E);

  E = rs12_filter_new_import("/tmp/E_filter_new_test");

  printf("\n");
  printf("E:\n");
  rs12_filter_new_printf(E);

  rs12_filter_new_destroy(&E);


  rank = 1;

  m = malloc(rank * sizeof(int));
  assert(m);

  m_zp = malloc(rank * sizeof(int));
  assert(m_zp);

  n_phy = malloc(rank * sizeof(int));
  assert(n_phy);

  n_phy_zp = malloc(rank * sizeof(int));
  assert(n_phy_zp);

  kind = malloc(rank * sizeof(rs12_filter_new_kind));;
  assert(kind);

  m[0] = 5;

  n_phy[0] = 3;

  kind[0] = TYPE1;



  /* Do zero padding */
  for (i = 0; i < rank; i++) {
    switch(kind[i]) {
    case TYPE1:
      n_log = 2*(n_phy[i] - 1);
      break;
    case TYPE2:
      n_log = 2*n_phy[i];
      break;
    default:
      assert(0);
    }

    /* Length of linear convolution */
    l = n_log + m[i] - 1;

    if (is_odd(l)) {
      l++;
    }

    switch(kind[i]) {
    case TYPE1:
      n_phy_zp[i] = l/2 + 1;
      break;
    case TYPE2:
      n_phy_zp[i] = l/2;
      break;
    default:
      assert(0);
    }

    m_zp[i] = l;
  }


  X = r_filter_new_create(rank, m_zp);
  H = rs12_filter_new_create(rank, n_phy_zp, kind);

  r_filter_new_set0(X);
  rs12_filter_new_set0(H);

  r_filter_new_init_n(X, m);
  rs12_filter_new_init_n(H, n_phy);

  printf("\n");
  printf("m:\n");
  for (i = 0; i < rank; i++) {
    printf("%d ", m[i]);
  }
  printf("\n");

  printf("\n");
  printf("m_zp:\n");
  for (i = 0; i < rank; i++) {
    printf("%d ", m_zp[i]);
  }
  printf("\n");

  printf("\n");
  printf("X:\n");
  r_filter_new_printf(X);

  printf("\n");
  printf("n_phy:\n");
  for (i = 0; i < rank; i++) {
    printf("%d ", n_phy[i]);
  }
  printf("\n");

  printf("\n");
  printf("n_phy_zp:\n");
  for (i = 0; i < rank; i++) {
    printf("%d ", n_phy_zp[i]);
  }
  printf("\n");

  printf("\n");
  printf("n_log_zp:\n");
  for (i = 0; i < rank; i++) {
    printf("%d ", H->n_log[i]);
  }
  printf("\n");

  printf("\n");
  printf("H:\n");
  rs12_filter_new_printf(H);

  r_filter_new_dft(X);
  rs12_filter_new_dft(H);
  rs12_filter_new_execute_r(H, X);
  r_filter_new_idft(X);

  /* NOTE: See note in filter_new.h for why we have abandoned this
     approach - it becomes difficult to do linear convolution by
     zero-padding and simultaneously preserving symmetry. */

  /* The result below is not correct. */

  printf("\n");
  printf("idft(dft(H).*dft(X)) (WRONG!)\n");
  r_filter_new_printf(X);

  free(m);
  free(n_phy);

  r_filter_new_destroy(&X);
  rs12_filter_new_destroy(&H);

  fftwe_cleanup();

  return 0;
}
